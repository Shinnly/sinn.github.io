<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fake Clock + Lap (picker / analog numerals)</title>
<style>
  :root { --fg:#fff; --bg:#111; --panel:#1a1a1a; --border:#333; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:14px;padding:16px}

  /* ==== 時計ブロック（上段） ==== */
  .clocks{display:flex;flex-direction:column;gap:14px;align-items:center;width:100%}

  /* デジタル */
  #clock{font-weight:800;line-height:1;text-align:center;font-variant-numeric:tabular-nums;
    font-size:16vw;margin-top:8px}
  @media (orientation:landscape){ #clock{font-size:12vh} }

  /* アナログ */
  .analog-wrap{display:flex;justify-content:center}
  #analog{width:min(72vw,420px);height:min(72vw,420px);background:#000;border-radius:50%;
    border:1px solid var(--border)}

  /* ==== Lap（大ボタン：時計直下） ==== */
  .lapRow{display:flex;justify-content:center;width:100%}
  #btnLap{
    font-size:18px;font-weight:800;
    padding:28px 18px;           /* ← 以前の約2倍の縦幅 */
    border-radius:16px;border:1px solid var(--border);
    background:#2a2a2a;color:var(--fg);cursor:pointer;touch-action:manipulation;
    width:min(900px,94vw)
  }

  /* ==== その他の設定（時計のさらに下） ==== */
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);
    background:#222;color:var(--fg);cursor:pointer;touch-action:manipulation}
  .picker{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  select.p{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);
    background:#222;color:var(--fg)}
  .toggles{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}

  .status{opacity:.85;font-size:14px;text-align:center}

  .tableWrap{width:min(900px,94vw);max-height:50vh;overflow:auto;border:1px solid var(--border);
    border-radius:10px;background:var(--panel)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;
    font-variant-numeric:tabular-nums}
  th{position:sticky;top:0;background:#181818}
  .ghost{display:none}
  label.inline{display:inline-flex;gap:6px;align-items:center;font-size:14px;opacity:.9}
</style>
</head>
<body>
<div class="wrap">

  <!-- ===== 時計（上段：デジタル／アナログ） ===== -->
  <div class="clocks">
    <div id="clock">--:--:--</div>
    <div class="analog-wrap">
      <canvas id="analog" width="420" height="420" aria-label="アナログ時計"></canvas>
    </div>
  </div>

  <!-- ===== Lap（時計直下・大ボタン） ===== -->
  <div class="lapRow">
    <button id="btnLap" onclick="doLap()" disabled>Lap</button>
  </div>

  <!-- ===== その他の設定（さらに下段） ===== -->
  <div class="picker">
    <label>時 <select id="hh" class="p" aria-label="時"></select></label>
    <label>分 <select id="mm" class="p" aria-label="分"></select></label>
    <label>秒 <select id="ss" class="p" aria-label="秒"></select></label>
  </div>

  <div class="controls">
    <button onclick="startClock()">Set & Start</button>
    <button id="btnFreeze" onclick="toggleFreeze()">Freeze</button>
    <button id="btnReset" onclick="doReset()" disabled>Reset</button>
    <button id="btnCopy" onclick="copyLaps()" disabled>Copy (TSV)</button>
  </div>

  <div class="toggles">
    <label class="inline"><input type="checkbox" id="showDigital" checked onchange="applyVisibility()"> デジタル表示</label>
    <label class="inline"><input type="checkbox" id="showAnalog"  checked onchange="applyVisibility()"> アナログ表示</label>
  </div>

  <div id="status" class="status">待機中（Set & Start で開始）</div>

  <div class="tableWrap">
    <table>
      <thead><tr><th>#</th><th>表示時刻</th><th>区間</th><th>累計</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <textarea id="fallbackText" class="ghost" rows="6" cols="60" readonly></textarea>
</div>

<script>
  // ---- 状態 ----
  var running=false, current=null, timer=null, startFake=null, lastLapFake=null, laps=[];

  // ---- Util ----
  function pad(n){ n=parseInt(n,10)||0; return ("0"+n).slice(-2); }
  function clamp(v,min,max){ v=parseInt(v,10)||0; if(v<min)v=min; if(v>max)v=max; return v; }
  function fmtClock(d){ return pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds()); }
  function fmtDur(ms){
    var s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60, ms3=("00"+(ms%1000)).slice(-3);
    return (h?pad(h)+":":"")+(h?pad(m):m)+":"+pad(sec)+"."+ms3;
  }
  function setStatus(t){ document.getElementById("status").textContent=t; }
  function drawDigital(){ document.getElementById("clock").textContent=current?fmtClock(current):"--:--:--"; }
  function setButtons(){
    document.getElementById("btnLap").disabled=!running;
    document.getElementById("btnReset").disabled=!startFake;
    var has = laps.length>0;
    document.getElementById("btnCopy").disabled=!has;
  }
  function tick(){
    if(running && current){
      current = new Date(current.getTime()+1000);
      drawDigital();
      drawAnalog();
    }
  }
  function loop(){ if(timer) clearInterval(timer); timer = setInterval(tick, 1000); }

  // ---- 表示切替 ----
  function applyVisibility(){
    var showD = document.getElementById("showDigital").checked;
    var showA = document.getElementById("showAnalog").checked;
    document.getElementById("clock").style.display  = showD ? "" : "none";
    document.querySelector(".analog-wrap").style.display = showA ? "" : "none";
  }

  // ---- アナログ描画（数字＆目盛） ----
  function drawAnalog(){
    var c = document.getElementById('analog'); if(!c) return;
    var ctx = c.getContext('2d');
    var W = c.width, H = c.height, r = Math.min(W,H)/2 - 12;
    ctx.clearRect(0,0,W,H);
    ctx.save();
    ctx.translate(W/2, H/2);

    // 盤
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fillStyle="#000"; ctx.fill();
    ctx.strokeStyle="#444"; ctx.lineWidth=2; ctx.stroke();

    // 分目盛(60) + 時目盛(12)
    for(var i=0;i<60;i++){
      var angle = Math.PI*2 * (i/60) - Math.PI/2;
      var inner = r - ((i%5===0)? 16 : 8);
      ctx.beginPath();
      ctx.moveTo(Math.cos(angle)*r, Math.sin(angle)*r);
      ctx.lineTo(Math.cos(angle)*inner, Math.sin(angle)*inner);
      ctx.strokeStyle = i%5===0 ? "#777" : "#555";
      ctx.lineWidth   = i%5===0 ? 3 : 1;
      ctx.stroke();
    }

    // 時数字（1〜12）
    ctx.fillStyle="#ddd";
    ctx.font = "bold "+Math.round(r*0.14)+"px -apple-system,system-ui,Segoe UI,Roboto";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    for(var h=1; h<=12; h++){
      var ang = Math.PI*2*(h/12) - Math.PI/2;
      var rr = r * 0.78; // 数字配置半径
      var x = Math.cos(ang)*rr, y = Math.sin(ang)*rr;
      ctx.fillText(String(h), x, y);
    }

    if(current){
      // 針
      var h = current.getHours()%12;
      var m = current.getMinutes();
      var s = current.getSeconds();
      var angH = (Math.PI*2)*((h + m/60 + s/3600)/12) - Math.PI/2;
      var angM = (Math.PI*2)*((m + s/60)/60) - Math.PI/2;
      var angS = (Math.PI*2)*(s/60) - Math.PI/2;

      // 時
      ctx.strokeStyle="#fff"; ctx.lineWidth=6; ctx.lineCap="round";
      ctx.beginPath(); ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(angH)*r*0.55, Math.sin(angH)*r*0.55); ctx.stroke();
      // 分
      ctx.strokeStyle="#ddd"; ctx.lineWidth=4;
      ctx.beginPath(); ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(angM)*r*0.78, Math.sin(angM)*r*0.78); ctx.stroke();
      // 秒
      ctx.strokeStyle="#ff5252"; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(angS)*r*0.85, Math.sin(angS)*r*0.85); ctx.stroke();
      // 中心
      ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fillStyle="#aaa"; ctx.fill();
    }

    ctx.restore();
  }

  // ---- ピッカー生成 ----
  function fillSelect(el, max, def){
    var html='', i=0;
    for(i=0;i<=max;i++){ var v=pad(i); html += '<option value="'+i+'"'+(i===def?' selected':'')+'>'+v+'</option>'; }
    el.innerHTML = html;
  }

  // ---- メイン操作 ----
  function startClock(){
    var H = clamp(document.getElementById("hh").value,0,23);
    var M = clamp(document.getElementById("mm").value,0,59);
    var S = clamp(document.getElementById("ss").value,0,59);
    var now = new Date();
    current   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), H, M, S);
    startFake = new Date(current.getTime());
    lastLapFake = new Date(current.getTime());
    laps = []; document.getElementById("tbody").innerHTML = "";
    running = true; drawDigital(); drawAnalog(); loop();
    setStatus("開始: "+pad(H)+":"+pad(M)+":"+pad(S)+" から進行中");
    document.getElementById("btnFreeze").textContent = "Freeze";
    setButtons();
  }

  function toggleFreeze(){
    if(!startFake) return;
    running = !running;
    document.getElementById("btnFreeze").textContent = running ? "Freeze" : "Resume";
    setStatus(running ? "再開" : "停止中（Freeze）");
    setButtons();
  }

  function doLap(){
    if(!current) return;
    var nowFake = new Date(current.getTime());
    var seg = nowFake - lastLapFake;
    var tot = nowFake - startFake;
    lastLapFake = new Date(nowFake.getTime());
    var row = { n:laps.length+1, clock:fmtClock(nowFake), seg:seg, tot:tot };
    laps.push(row);

    var tr = document.createElement("tr");
    tr.innerHTML = "<td>"+row.n+"</td><td>"+row.clock+"</td><td>"+fmtDur(row.seg)+"</td><td>"+fmtDur(row.tot)+"</td>";
    document.getElementById("tbody").appendChild(tr);

    var box = document.querySelector(".tableWrap");
    box.scrollTop = box.scrollHeight;

    setButtons();
  }

  function doReset(){
    running=false; current=null; startFake=null; lastLapFake=null; laps=[];
    if(timer) clearInterval(timer);
    drawDigital(); drawAnalog();
    setStatus("リセットしました");
    document.getElementById("tbody").innerHTML="";
    document.getElementById("btnFreeze").textContent="Freeze";
    setButtons();
  }

  // ---- 出力（コピーのみ：TSV） ----
  function lapsAsTSV(){
    var lines = ["#\t表示時刻\t区間(ms)\t区間(表示)\t累計(ms)\t累計(表示)"];
    for(var i=0;i<laps.length;i++){
      var r=laps[i];
      lines.push([r.n, r.clock, r.seg, fmtDur(r.seg), r.tot, fmtDur(r.tot)].join("\t"));
    }
    return lines.join("\n");
  }

  async function copyLaps(){
    var tsv = lapsAsTSV();
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(tsv);
        setStatus("TSVをクリップボードへコピーしました");
        return;
      }
    }catch(e){}
    try{
      var ta = document.createElement("textarea");
      ta.value = tsv;
      document.body.appendChild(ta);
      ta.select();
      var ok = document.execCommand("copy");
      document.body.removeChild(ta);
      setStatus(ok ? "TSVをクリップボードへコピーしました" : "コピー失敗");
      if(ok) return;
    }catch(e){}
    var fb = document.getElementById("fallbackText");
    fb.classList.remove("ghost");
    fb.value = tsv;
    fb.focus(); fb.select();
    setStatus("コピー不可のため下のテキストから手動コピーしてください");
  }

  // ---- 初期化（?time=HH:MM[:SS] もサポート）----
  (function init(){
    // ピッカーを生成
    var now = new Date();
    var defH = 9, defM = 00, defS = 0;
    var params = new URLSearchParams(location.search);
    var q = params.get("time");
    if(q){
      var p = q.split(":");
      defH = clamp(p[0],0,23); defM = clamp(p[1],0,59); defS = clamp(p[2]||0,0,59);
    }
    fillSelect(document.getElementById("hh"), 23, defH);
    fillSelect(document.getElementById("mm"), 59, defM);
    fillSelect(document.getElementById("ss"), 59, defS);

    current = new Date(now.getFullYear(), now.getMonth(), now.getDate(), defH, defM, defS);
    drawDigital(); drawAnalog();
    setButtons();
    applyVisibility(); // 初期の表示反映
  })();
</script>
</body>
</html>