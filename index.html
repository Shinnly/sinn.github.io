<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fake Clock + Lap</title>
<style>
  :root { --fg:#fff; --bg:#111; --panel:#1a1a1a; --border:#333; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,system-ui,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:14px;padding:16px}
  #clock{font-weight:800;line-height:1;text-align:center;font-variant-numeric:tabular-nums;
    font-size:16vw;margin-top:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  input.num{width:5.5ch;text-align:center;font-size:17px;padding:8px 10px;border-radius:8px;
    border:1px solid var(--border);background:#222;color:var(--fg);appearance:textfield}
  button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);
    background:#222;color:var(--fg);cursor:pointer;touch-action:manipulation}
  .status{opacity:.85;font-size:14px;text-align:center}
  .tableWrap{width:min(900px,94vw);max-height:50vh;overflow:auto;border:1px solid var(--border);
    border-radius:10px;background:var(--panel)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;
    font-variant-numeric:tabular-nums}
  th{position:sticky;top:0;background:#181818}
  .ghost{display:none}
  @media (orientation:landscape){ #clock{font-size:12vh} }
</style>
</head>
<body>
<div class="wrap">
  <div id="clock">--:--:--</div>

  <div class="row">
    <input id="hh" class="num" type="number" min="0" max="23" value="19" aria-label="時">
    <input id="mm" class="num" type="number" min="0" max="59" value="55" aria-label="分">
    <input id="ss" class="num" type="number" min="0" max="59" value="0"  aria-label="秒">
    <button onclick="startClock()">Set & Start</button>
    <button id="btnFreeze" onclick="toggleFreeze()">Freeze</button>
    <button id="btnLap" onclick="doLap()" disabled>Lap</button>
    <button id="btnReset" onclick="doReset()" disabled>Reset</button>
    <button id="btnCopy" onclick="copyLaps()" disabled>Copy</button>
    <button id="btnDownload" onclick="downloadCSV()" disabled>DL CSV</button>
  </div>

  <div id="status" class="status">待機中（Set & Start で開始）</div>

  <div class="tableWrap">
    <table>
      <thead><tr><th>#</th><th>表示時刻</th><th>区間</th><th>累計</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- 手動コピー用（最終フォールバック） -->
  <textarea id="fallbackText" class="ghost" rows="6" cols="60" readonly></textarea>
</div>

<script>
  // ---- 状態 ----
  var running=false, current=null, timer=null, startFake=null, lastLapFake=null, laps=[];
  // ---- Util ----
  function pad(n){ n=parseInt(n,10)||0; return ("0"+n).slice(-2); }
  function clamp(v,min,max){ v=parseInt(v,10)||0; if(v<min)v=min; if(v>max)v=max; return v; }
  function fmtClock(d){ return pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds()); }
  function fmtDur(ms){
    var s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60, ms3=("00"+(ms%1000)).slice(-3);
    return (h?pad(h)+":":"")+(h?pad(m):m)+":"+pad(sec)+"."+ms3;
  }
  function setStatus(t){ document.getElementById("status").textContent=t; }
  function draw(){ document.getElementById("clock").textContent=current?fmtClock(current):"--:--:--"; }
  function setButtons(){
    document.getElementById("btnLap").disabled=!running;
    document.getElementById("btnReset").disabled=!startFake;
    var has = laps.length>0;
    document.getElementById("btnCopy").disabled=!has;
    document.getElementById("btnDownload").disabled=!has;
  }
  function tick(){ if(running && current){ current = new Date(current.getTime()+1000); draw(); } }
  function loop(){ if(timer) clearInterval(timer); timer = setInterval(tick, 1000); }

  // ---- メイン操作 ----
  function startClock(){
    var H = clamp(document.getElementById("hh").value,0,23);
    var M = clamp(document.getElementById("mm").value,0,59);
    var S = clamp(document.getElementById("ss").value,0,59);
    var now = new Date();
    current   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), H, M, S);
    startFake = new Date(current.getTime());
    lastLapFake = new Date(current.getTime());
    laps = []; document.getElementById("tbody").innerHTML = "";
    running = true; draw(); loop();
    setStatus("開始: "+pad(H)+":"+pad(M)+":"+pad(S)+" から進行中");
    document.getElementById("btnFreeze").textContent = "Freeze";
    setButtons();
  }

  function toggleFreeze(){
    if(!startFake) return;
    running = !running;
    document.getElementById("btnFreeze").textContent = running ? "Freeze" : "Resume";
    setStatus(running ? "再開" : "停止中（Freeze）");
    setButtons();
  }

  function doLap(){
    if(!current) return;
    var nowFake = new Date(current.getTime());
    var seg = nowFake - lastLapFake;
    var tot = nowFake - startFake;
    lastLapFake = new Date(nowFake.getTime());
    var row = { n:laps.length+1, clock:fmtClock(nowFake), seg:seg, tot:tot };
    laps.push(row);

    var tr = document.createElement("tr");
    tr.innerHTML = "<td>"+row.n+"</td><td>"+row.clock+"</td><td>"+fmtDur(row.seg)+"</td><td>"+fmtDur(row.tot)+"</td>";
    document.getElementById("tbody").appendChild(tr);

    // スクロールを末尾へ
    var box = document.querySelector(".tableWrap");
    box.scrollTop = box.scrollHeight;

    setButtons();
  }

  function doReset(){
    running=false; current=null; startFake=null; lastLapFake=null; laps=[];
    if(timer) clearInterval(timer);
    draw(); setStatus("リセットしました");
    document.getElementById("tbody").innerHTML="";
    document.getElementById("btnFreeze").textContent="Freeze";
    setButtons();
  }

  // ---- 出力（コピー／DL） ----
  function lapsAsTSV(){
    var lines = ["#\t表示時刻\t区間(ms)\t区間(表示)\t累計(ms)\t累計(表示)"];
    for(var i=0;i<laps.length;i++){
      var r=laps[i];
      lines.push([r.n, r.clock, r.seg, fmtDur(r.seg), r.tot, fmtDur(r.tot)].join("\t"));
    }
    return lines.join("\n");
  }
  function lapsAsCSV(){
    // CSVはカンマ区切り＋引用符
    var esc = function(s){ return '"'+String(s).replace(/"/g,'""')+'"'; };
    var lines = [["#", "表示時刻", "区間(ms)", "区間(表示)", "累計(ms)", "累計(表示)"]];
    for(var i=0;i<laps.length;i++){
      var r=laps[i];
      lines.push([r.n, r.clock, r.seg, fmtDur(r.seg), r.tot, fmtDur(r.tot)]);
    }
    return lines.map(function(arr){ return arr.map(esc).join(","); }).join("\n");
  }

  async function copyLaps(){
    var tsv = lapsAsTSV();
    // 1) Clipboard API
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(tsv);
        setStatus("TSVをクリップボードへコピーしました");
        return;
      }
    }catch(e){/* fallthrough */}
    // 2) execCommand
    try{
      var ta = document.createElement("textarea");
      ta.value = tsv;
      document.body.appendChild(ta);
      ta.select();
      var ok = document.execCommand("copy");
      document.body.removeChild(ta);
      setStatus(ok ? "TSVをクリップボードへコピーしました" : "コピー失敗");
      if(ok) return;
    }catch(e){/* fallthrough */}
    // 3) 手動コピー
    var fb = document.getElementById("fallbackText");
    fb.classList.remove("ghost");
    fb.value = tsv;
    fb.focus(); fb.select();
    setStatus("コピー不可のため下のテキストから手動コピーしてください");
  }

  function downloadCSV(){
    var csv = lapsAsCSV();
    try{
      var blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = "laps.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
      setStatus("CSVをダウンロードしました");
    }catch(e){
      // data:URL フォールバック
      var data = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
      location.href = data;
    }
  }

  // ---- 初期化（?time=HH:MM[:SS] もサポート）----
  (function init(){
    var params = new URLSearchParams(location.search);
    var q = params.get("time");
    var now = new Date();
    if(q){
      var p = q.split(":");
      var H = clamp(p[0],0,23), M = clamp(p[1],0,59), S = clamp(p[2]||0,0,59);
      current = new Date(now.getFullYear(), now.getMonth(), now.getDate(), H, M, S);
      document.getElementById("hh").value=H; document.getElementById("mm").value=M; document.getElementById("ss").value=S;
    }else{
      current = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 19, 55, 0);
    }
    draw(); setButtons();
  })();
</script>
</body>
</html>
